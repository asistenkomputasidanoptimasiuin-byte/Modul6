{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Analisis & Forecasting</h1>
    </div>
</div>

<div class="row">
    <!-- Sales Trend Chart -->
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0"><i class="fas fa-chart-line me-2"></i>Trend Penjualan & Forecasting</h5>
            </div>
            <div class="card-body">
                <canvas id="salesChart" height="250"></canvas>
            </div>
        </div>
    </div>

    <!-- Forecasting Results -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0"><i class="fas fa-calculator me-2"></i>Hasil Forecasting</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Periode</th>
                                <th>Peramalan (rim)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for forecast in forecasts %}
                            <tr>
                                <td>Bulan ke-{{ forecast.period }}</td>
                                <td><strong>{{ forecast.forecast }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Forecasting menggunakan metode linear regression berdasarkan data historis penjualan.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sales Data -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0"><i class="fas fa-table me-2"></i>Data Penjualan Historis</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Bulan</th>
                                <th>Produk</th>
                                <th>Jumlah Terjual (rim)</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sale in sales_data %}
                            <tr>
                                <td>{{ sale.date }}</td>
                                <td>Kertas HVS A4</td>
                                <td>{{ sale.quantity }}</td>
                                <td>
                                    {% if loop.index > 1 %}
                                        {% set prev_quantity = sales_data[loop.index0 - 1].quantity %}
                                        {% set change = ((sale.quantity - prev_quantity) / prev_quantity * 100) %}
                                        <span class="badge {% if change > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ "%+.1f"|format(change) }}%
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analysis Summary -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0"><i class="fas fa-lightbulb me-2"></i>Rekomendasi Produksi</h5>
            </div>
            <div class="card-body">
                {% if forecasts %}
                    {% set avg_forecast = (forecasts[0].forecast + forecasts[1].forecast + forecasts[2].forecast) / 3 %}
                    <p>Berdasarkan forecasting, rata-rata permintaan untuk 3 bulan ke depan adalah <strong>{{ "%.0f"|format(avg_forecast) }} rim</strong> per bulan.</p>
                    
                    <h6>Saran Produksi:</h6>
                    <ul>
                        <li>Rencanakan produksi bulanan sekitar <strong>{{ "%.0f"|format(avg_forecast * 1.1) }}</strong> rim untuk mengantisipasi fluktuasi permintaan</li>
                        <li>Perhatikan ketersediaan bahan baku pulp untuk memenuhi target produksi</li>
                        <li>Optimalkan jadwal maintenance mesin untuk meminimalkan downtime</li>
                    </ul>
                {% else %}
                    <p>Data forecasting tidak tersedia. Pastikan data penjualan sudah dimasukkan.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Peringatan Kinerja</h5>
            </div>
            <div class="card-body">
                <h6>Area Perbaikan:</h6>
                <ul>
                    <li>Monitor terus tingkat defect produk untuk meningkatkan kualitas</li>
                    <li>Optimalkan waktu setup mesin untuk meningkatkan availability</li>
                    <li>Lakukan preventive maintenance secara berkala</li>
                    <li>Analisis root cause untuk downtime yang berulang</li>
                </ul>
                
                <div class="alert alert-info mt-3">
                    <small>
                        <strong>Tip:</strong> Target OEE dunia kelas adalah 85%. 
                        Usahakan untuk mencapai availability ≥ 90%, performance ≥ 95%, dan quality ≥ 99%.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const salesDates = {{ sales_dates | safe }};
    const salesQuantities = {{ sales_quantities | safe }};
    
    // Prepare forecast data
    const forecastDates = [];
    const forecastQuantities = [];
    
    {% for forecast in forecasts %}
    forecastDates.push(`Bulan +{{ forecast.period }}`);
    forecastQuantities.push({{ forecast.forecast }});
    {% endfor %}
    
    // Combine historical and forecast data
    const allDates = [...salesDates, ...forecastDates];
    const allQuantities = [...salesQuantities, ...forecastQuantities];
    
    // Create chart
    const ctx = document.getElementById('salesChart').getContext('2d');
    const salesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: allDates,
            datasets: [
                {
                    label: 'Data Historis',
                    data: [...salesQuantities, ...Array(forecastQuantities.length).fill(null)],
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.1,
                    fill: true
                },
                {
                    label: 'Forecasting',
                    data: [...Array(salesQuantities.length).fill(null), ...forecastQuantities],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderDash: [5, 5],
                    tension: 0.1,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Trend Penjualan & Forecasting Permintaan'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Periode'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Jumlah (rim)'
                    },
                    beginAtZero: true
                }
            }
        }
    });
});
</script>
{% endblock %}